# 504 Gateway Time-out 优化方案

## 🔍 问题分析

从浏览器开发者工具可以看到：
- **错误**：`504 Gateway Time-out`
- **请求体大小**：`Content-Length: 230748`（约230KB）
- **请求URL**：`https://drug-api.be724115.er.aliyun-esa.net/recognize`

## 🐛 根本原因

504错误表示**边缘函数的网关超时**，可能的原因：

1. **图片数据过大**
   - 请求体约230KB，包含两张图片的base64数据
   - 即使压缩后，base64编码仍然较大

2. **并发处理导致总时间过长**
   - 代码中并发处理多张图片
   - 每张图片可能需要20-30秒
   - 总时间可能超过网关超时限制（通常30-60秒）

3. **网关超时设置过短**
   - ESA边缘函数的网关超时可能只有30-60秒
   - 代码中设置了60秒fetch超时 + 45秒读取超时
   - 但网关可能在更短的时间内就超时了

## ✅ 已实施的优化

### 1. 优化图片压缩策略

**前端压缩优化**（`frontend/src/utils/imageUtils.ts`）：
- **降低压缩阈值**：从2MB降低到1MB
- **更激进的压缩**：
  - 第一轮：1920x1920, 质量0.7
  - 第二轮：1280x1280, 质量0.6（如果>1.5MB）
  - 第三轮：1024x1024, 质量0.5（如果>1MB）

### 2. 改为串行处理

**边缘函数处理优化**（`修复后的单文件代码.js`）：
- **从并发改为串行**：一张一张处理图片
- **减少单张超时**：从25秒降低到20秒
- **添加延迟**：每张图片处理完后延迟500ms，避免API限流

### 3. 降低大小限制

**边缘函数大小检查**：
- **降低限制**：从5MB降低到2MB
- **提前拒绝**：过大的图片直接返回错误，避免超时

## 📋 进一步优化建议

### 方案1：增加边缘函数超时设置（最重要）⚠️

1. 登录 [阿里云ESA控制台](https://esa.console.aliyun.com/)
2. 进入 **边缘函数** 管理页面
3. 找到您的函数（例如：`drug-api`）
4. 进入函数设置，找到 **超时时间** 或 **Timeout** 配置
5. 将超时时间设置为 **90秒或更长**
6. 保存并重新部署

### 方案2：如果无法增加超时设置

如果无法修改网关超时设置，可以：

1. **进一步压缩图片**
   - 将压缩阈值降低到500KB
   - 将最大尺寸降低到800x800
   - 将质量降低到0.4

2. **限制图片数量**
   - 前端限制一次最多上传2张图片
   - 提示用户如果图片较多，分批上传

3. **优化API调用**
   - 减少API的max_tokens
   - 简化prompt，减少处理时间

## 🧪 测试步骤

1. **重新部署前端**
   - 前端代码已优化图片压缩
   - 需要重新构建和部署

2. **重新部署边缘函数**
   - 边缘函数已改为串行处理
   - 需要重新部署

3. **测试小图片**
   - 先测试单张小图片（<500KB）
   - 确认不会超时

4. **测试多张图片**
   - 测试2张图片串行处理
   - 确认总时间不超过网关超时

## 📊 预期效果

- **图片大小**：从230KB降低到约100-150KB
- **处理时间**：串行处理，每张20秒，2张约40-45秒
- **超时风险**：如果网关超时>60秒，应该不会超时

## ⚠️ 如果仍然超时

如果优化后仍然超时：

1. **检查边缘函数日志**
   - 查看具体在哪一步超时
   - 查看每张图片的处理时间

2. **联系技术支持**
   - 询问边缘函数的默认超时时间
   - 请求增加超时时间到90秒或更长

3. **考虑分批上传**
   - 前端限制一次最多1-2张图片
   - 提示用户分批上传

## ✅ 优化检查清单

- [x] 优化前端图片压缩（降低阈值，更激进压缩）
- [x] 改为串行处理（避免并发导致总时间过长）
- [x] 减少单张图片超时（从25秒降低到20秒）
- [x] 降低大小限制（从5MB降低到2MB）
- [ ] 检查边缘函数超时设置（如果可能，增加到90秒）
- [ ] 重新部署前端和边缘函数
- [ ] 测试优化后的效果

