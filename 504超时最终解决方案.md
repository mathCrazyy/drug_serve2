# 504 Gateway Time-out 最终解决方案

## 当前问题

✅ **请求方法正确**：POST（从Network标签可以看到）
✅ **URL路径正确**：`https://drug-api.be724115.er.aliyun-esa.net/recognize`
❌ **504 Gateway Time-out**：边缘函数执行超时

## 问题分析

504错误表示边缘函数执行时间超过了网关的超时限制。即使代码已优化，如果网关的超时设置太短（如30秒），仍然会超时。

## 解决方案

### 方案1：联系阿里云技术支持（推荐）⚠️

如果找不到超时设置，最好的方法是联系技术支持：

1. **在阿里云控制台**：
   - 找到 **"工单"** 或 **"技术支持"** 入口
   - 创建工单

2. **询问以下问题**：
   - 边缘函数的默认超时时间是多少？
   - 如何修改边缘函数的超时时间？
   - 超时设置在哪里可以找到？
   - 我的函数URL是：`https://drug-api.be724115.er.aliyun-esa.net`

3. **提供信息**：
   - 函数名称或ID
   - 遇到的错误：504 Gateway Time-out
   - 需要处理图片识别，可能需要较长时间

### 方案2：查看边缘函数日志

1. **进入边缘函数控制台**
2. **找到你的函数**
3. **查看"日志"或"Logs"**
4. **查看**：
   - 函数是否收到请求
   - 执行到哪一步
   - 是否有超时相关的错误信息
   - 实际执行了多长时间

从日志中可以推断：
- 如果日志显示执行了30秒后停止，说明超时是30秒
- 如果日志显示执行了60秒后停止，说明超时是60秒

### 方案3：测试单张图片

1. **只上传1张图片**测试
2. **如果单张图片成功**：
   - 说明是并发处理导致的问题
   - 可以考虑优化代码，改为串行处理

3. **如果单张图片也超时**：
   - 说明是单次API调用时间过长
   - 需要增加超时设置或优化API调用

### 方案4：检查图片大小

1. **在浏览器开发者工具中**：
   - 打开 Network 标签
   - 点击 `recognize` 请求
   - 查看 **Request Payload** 的大小

2. **如果请求体很大**（> 1MB）：
   - 说明图片压缩可能没有生效
   - 需要检查前端图片压缩功能

3. **如果请求体正常**（< 500KB）：
   - 说明问题不在图片大小
   - 可能是API响应慢或超时设置太短

## 临时解决方案

如果无法修改超时设置，可以尝试：

### 1. 使用更小的图片测试

- 上传一张很小的图片（< 50KB）
- 测试是否能成功
- 如果能成功，说明是大图片导致的问题

### 2. 检查豆包API响应时间

- 豆包API可能需要较长时间处理图片
- 如果API本身响应慢，即使增加超时也可能不够

### 3. 考虑分批处理

- 如果有多张图片，可以考虑：
  - 前端分批上传（一次1张）
  - 或者后端改为串行处理（已优化为1张）

## 下一步操作

**立即执行**（按优先级）：

1. **查看边缘函数日志**：
   - 确认实际执行时间
   - 查看是否有错误信息

2. **测试单张小图片**：
   - 上传一张很小的图片（< 50KB）
   - 测试是否能成功

3. **联系阿里云技术支持**：
   - 询问超时设置的位置和默认值
   - 请求增加超时时间

4. **如果以上都无效**：
   - 告诉我日志中的信息
   - 我可以根据实际情况进一步优化代码

## 检查清单

- [ ] 已查看边缘函数日志
- [ ] 已测试单张小图片
- [ ] 已联系技术支持（如果找不到超时设置）
- [ ] 已检查请求体大小
- [ ] 已确认代码已更新

## 重要提示

- **504错误是网关超时**，不是代码错误
- **需要增加边缘函数的超时设置**才能解决
- **如果找不到设置**，必须联系技术支持
- **代码优化只能减少执行时间**，不能解决网关超时问题

