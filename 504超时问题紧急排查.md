# 504超时问题紧急排查指南

## 🔴 当前状态

从浏览器开发者工具可以看到：
- **错误**：`504 Gateway Time-out`
- **请求体大小**：`Content-Length: 230748`（约230KB）
- **问题**：即使优化后，请求体仍然很大，导致超时

## ⚠️ 关键问题

**请求体仍然是230KB，说明：**
1. ❌ 前端可能还没有重新部署（压缩优化未生效）
2. ❌ 或者压缩后仍然很大（需要更激进的压缩）

## ✅ 立即执行的步骤

### 步骤1：确认前端已重新部署 ⚠️ 最重要

1. 登录 [阿里云ESA控制台](https://esa.console.aliyun.com/)
2. 进入 **Pages** 管理页面
3. 找到您的站点（`drug-serve2`）
4. 检查 **最新部署时间**
5. 如果部署时间早于代码提交时间，**立即重新部署**

### 步骤2：验证压缩是否生效

重新部署后，打开浏览器开发者工具：

1. 打开 **Console** 标签
2. 上传图片
3. 查看是否有 `[图片压缩]` 的日志输出
4. 查看压缩后的图片大小

**预期输出示例：**
```
[图片压缩] 原始大小: 2048.00KB
[图片压缩] 第一轮后: 512.00KB
[图片压缩] 压缩率: 75.0%
[API] 请求体大小: 150.00KB
```

### 步骤3：检查边缘函数超时设置 ⚠️ 关键

即使压缩生效，如果边缘函数超时设置太短，仍然会超时：

1. 登录 [阿里云ESA控制台](https://esa.console.aliyun.com/)
2. 进入 **边缘函数** 管理页面
3. 找到您的函数（`drug-api`）
4. 进入函数设置
5. 查找 **超时时间** 或 **Timeout** 配置
6. **必须设置为 90秒或更长**

**如果找不到超时设置：**
- 联系阿里云技术支持
- 询问边缘函数的默认超时时间
- 请求增加超时时间到90秒

### 步骤4：重新部署边缘函数

如果修改了超时设置，必须重新部署边缘函数。

## 🔧 已实施的优化

### 1. 前端压缩优化（最新）

- **压缩阈值**：从1MB降低到500KB
- **更激进的压缩**：
  - 第一轮：1280x1280, 质量0.6
  - 第二轮：1024x1024, 质量0.5（如果>800KB）
  - 第三轮：800x800, 质量0.4（如果>500KB）
- **添加压缩日志**：方便调试

### 2. 边缘函数优化

- **串行处理**：一张一张处理，避免并发超时
- **减少单张超时**：从25秒降低到20秒
- **降低大小限制**：从5MB降低到2MB

### 3. API请求优化

- **添加请求体大小日志**：显示实际请求大小
- **特殊处理504错误**：提供更详细的错误提示

## 📊 预期效果

### 如果压缩生效：

- **单张图片**：从2MB压缩到约100-200KB
- **2张图片**：从230KB降低到约200-400KB
- **处理时间**：串行处理，每张20秒，2张约40-45秒

### 如果仍然超时：

1. **检查边缘函数日志**：查看具体超时位置
2. **减少图片数量**：先测试单张图片
3. **联系技术支持**：请求增加超时时间

## 🧪 测试步骤

### 测试1：验证压缩是否生效

1. 打开浏览器开发者工具（F12）
2. 进入 **Console** 标签
3. 上传一张图片
4. 查看是否有压缩日志
5. 查看请求体大小是否降低

### 测试2：测试单张图片

1. 只上传1张图片
2. 点击"开始识别"
3. 如果单张也超时，说明超时设置太短

### 测试3：测试多张图片

1. 上传2张图片
2. 点击"开始识别"
3. 查看是否超时

## ⚠️ 如果仍然超时

### 方案1：进一步降低图片质量（临时方案）

如果压缩后仍然很大，可以临时降低质量：

```typescript
// 在 imageUtils.ts 中，进一步降低质量
processedFile = await compressImage(file, 800, 800, 0.3); // 质量0.3
```

### 方案2：限制图片数量

在前端限制一次最多上传1-2张图片：

```typescript
// 在 ImageUploader.tsx 中
if (validFiles.length > 2) {
  alert('一次最多上传2张图片，请分批上传');
  validFiles = validFiles.slice(0, 2);
}
```

### 方案3：联系技术支持

如果以上方案都不行，必须联系技术支持：

1. **询问超时设置位置**
2. **请求增加超时时间到90秒或更长**
3. **提供错误日志和请求详情**

## ✅ 检查清单

- [ ] **前端已重新部署**（检查部署时间）
- [ ] **浏览器Console显示压缩日志**
- [ ] **请求体大小已降低**（<200KB）
- [ ] **边缘函数超时设置≥90秒**
- [ ] **边缘函数已重新部署**
- [ ] **测试单张图片不超时**
- [ ] **测试2张图片不超时**

## 📝 重要提示

1. **504错误是网关超时**，不是代码错误
2. **必须增加边缘函数超时设置**才能彻底解决
3. **压缩优化只能减少超时风险**，不能解决网关超时
4. **如果找不到超时设置，必须联系技术支持**

## 🆘 紧急联系

如果以上步骤都无法解决，请：
1. 截图边缘函数日志
2. 截图浏览器Console日志
3. 联系阿里云技术支持
4. 提供错误详情和配置信息

