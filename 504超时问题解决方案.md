# 504 Gateway Time-out 问题解决方案

## 问题分析

✅ **URL路径已修复**：请求URL现在是正确的 `https://drug-api.be724115.er.aliyun-esa.net/recognize`

❌ **新问题**：`504 Gateway Time-out` - 边缘函数执行超时

## 504超时的原因

504错误表示边缘函数执行时间超过了网关的超时限制（通常是30-60秒）。

### 可能的原因：

1. **边缘函数超时设置过短** ⚠️ **最可能**
   - 代码中设置了60秒fetch超时 + 45秒读取超时
   - 但边缘函数本身的超时可能更短（如30秒）

2. **豆包API响应慢**
   - 图片识别需要较长时间
   - 网络延迟导致响应慢

3. **图片处理时间过长**
   - 虽然前端已压缩，但可能仍然较大
   - 两张图片并发处理可能超时

## 解决方案

### 方案1：增加边缘函数超时设置（最重要）⚠️

**在阿里云ESA边缘函数控制台**：

1. 进入函数详情
2. 找到 **超时时间** 或 **Timeout** 设置
3. **设置为 120秒或更长**
   - 代码中：60秒fetch超时 + 45秒读取超时 = 至少105秒
   - 加上处理时间，建议设置为 **120秒**
4. 保存设置

### 方案2：优化代码，减少并发处理

如果超时设置已经足够，但仍然超时，可以：

1. **减少并发数量**：修改代码中的 `maxConcurrent = 1`（一次只处理1张图片）
2. **减少超时时间**：将fetch超时从60秒减少到45秒，读取超时从45秒减少到30秒
3. **优化图片大小**：确保前端图片压缩正常工作

### 方案3：检查边缘函数日志

在边缘函数控制台：
1. 进入函数详情
2. 查看 **日志** 或 **Logs**
3. 查看：
   - 函数是否收到请求
   - 执行到哪一步
   - 是否有错误信息
   - 实际执行时间

## 立即操作步骤

### 步骤1：检查边缘函数超时设置（立即执行）

1. 进入阿里云ESA边缘函数控制台
2. 找到函数：`drug-api` 或类似名称
3. 进入函数设置
4. 找到 **超时时间** 或 **Timeout**
5. **设置为 120秒**
6. 保存并重新部署

### 步骤2：测试小图片

1. 上传一张很小的图片（< 100KB）
2. 测试是否能成功
3. 如果小图片成功，说明是大图片或并发导致的问题

### 步骤3：如果仍然超时

1. **查看边缘函数日志**：确认实际执行时间
2. **减少并发**：修改代码，一次只处理1张图片
3. **联系技术支持**：如果超时设置已足够但仍然超时

## 代码优化建议

如果超时设置已足够但仍然超时，可以考虑：

1. **串行处理图片**（而不是并发）：
   ```javascript
   // 将 maxConcurrent 从 3 改为 1
   const maxConcurrent = 1;
   ```

2. **减少超时时间**（避免长时间等待）：
   ```javascript
   // fetch超时从60秒改为45秒
   const timeoutId = setTimeout(() => controller.abort(), 45000);
   // 读取超时从45秒改为30秒
   const readTimeout = 30000;
   ```

3. **添加进度反馈**：
   - 在处理过程中返回进度信息
   - 避免用户长时间等待

## 验证修复

修复后，在浏览器开发者工具中检查：

1. **Network标签**：
   - 请求URL应该是：`https://drug-api.be724115.er.aliyun-esa.net/recognize` ✅
   - 状态码应该是：`200 OK`（而不是 `504 Gateway Time-out`）

2. **响应时间**：
   - 如果成功，响应时间应该在60-90秒内
   - 如果超过120秒，说明需要进一步优化

## 如果问题持续

如果设置了120秒超时但仍然超时：

1. **检查边缘函数日志**：查看实际执行时间
2. **测试单张图片**：确认是否是并发处理导致的问题
3. **联系阿里云技术支持**：检查边缘函数到豆包API的网络连接

