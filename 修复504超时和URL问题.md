# 修复504超时和URL路径重复问题

## 问题1：URL路径重复 `/recognize/recognize`

### 原因
前端环境变量 `VITE_API_BASE_URL` 配置错误，包含了路径 `/recognize`。

### 错误配置
```
VITE_API_BASE_URL = https://drug-api.be724115.er.aliyun-esa.net/recognize ❌
```

### 正确配置
```
VITE_API_BASE_URL = https://drug-api.be724115.er.aliyun-esa.net ✅
```

### 修复步骤

1. **在ESA Pages环境变量中修改**：
   - 进入 ESA Pages 控制台
   - 找到环境变量配置
   - 将 `VITE_API_BASE_URL` 修改为：`https://drug-api.be724115.er.aliyun-esa.net`
   - **不要包含路径** `/recognize`
   - 保存并重新部署

2. **验证配置**：
   - 前端代码会自动拼接路径：`${API_BASE_URL}/recognize`
   - 最终URL应该是：`https://drug-api.be724115.er.aliyun-esa.net/recognize`

## 问题2：504 Gateway Time-out

### 原因
边缘函数执行时间超过了网关的超时限制（通常是30-60秒）。

### 解决方案

#### 1. 检查边缘函数超时设置（最重要）⚠️

在阿里云ESA边缘函数控制台：

1. 进入函数详情
2. 找到 **超时时间** 或 **Timeout** 设置
3. **必须设置为 120秒或更长**
   - 代码中：60秒fetch超时 + 45秒读取超时 = 至少105秒
   - 加上处理时间，建议设置为 **120秒**
4. 保存设置

#### 2. 优化代码执行时间

如果超时设置已经足够，但仍然超时，可以：

1. **减少并发处理**：修改代码中的 `maxConcurrent = 1`（一次只处理1张图片）
2. **减少重试次数**：将 `maxRetries` 从2减少到1
3. **优化图片大小**：确保前端图片压缩正常工作

#### 3. 检查边缘函数日志

在边缘函数控制台：
1. 进入函数详情
2. 查看 **日志** 或 **Logs**
3. 查看：
   - 函数是否收到请求
   - 执行到哪一步
   - 是否有错误信息

## 快速修复步骤

### 步骤1：修复URL配置（立即执行）

在ESA Pages环境变量中：
```
VITE_API_BASE_URL = https://drug-api.be724115.er.aliyun-esa.net
```
（注意：不要包含 `/recognize` 路径）

### 步骤2：检查边缘函数超时（立即执行）

在边缘函数控制台：
- 将超时时间设置为 **120秒**

### 步骤3：重新部署

1. 重新部署前端（如果修改了环境变量）
2. 重新部署边缘函数（如果修改了超时设置）

### 步骤4：测试

1. 上传一张小图片（< 100KB）测试
2. 如果成功，再测试大图片
3. 如果仍然超时，查看边缘函数日志

## 验证修复

修复后，在浏览器开发者工具中检查：

1. **Network标签**：
   - 请求URL应该是：`https://drug-api.be724115.er.aliyun-esa.net/recognize`
   - **不应该**是：`https://drug-api.be724115.er.aliyun-esa.net/recognize/recognize`

2. **响应状态**：
   - 应该是 `200 OK`
   - **不应该**是 `504 Gateway Time-out`

## 如果问题持续

如果修复后仍然超时：

1. **检查边缘函数日志**：查看具体在哪一步超时
2. **测试单张图片**：确认是否是并发处理导致的问题
3. **联系阿里云技术支持**：检查边缘函数到豆包API的网络连接

