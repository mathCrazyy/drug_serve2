# ERR_CONNECTION_CLOSED 完整排查指南

## 当前问题

前端调用边缘函数时出现 `ERR_CONNECTION_CLOSED` 错误，连接被关闭。

## 排查步骤

### 1. 确认环境变量配置 ✅

**正确配置**：
```
VITE_API_BASE_URL = https://orange-butterfly-4818.be724115.er.aliyun-esa.net
```

**错误配置**（会导致路径重复）：
```
VITE_API_BASE_URL = https://orange-butterfly-4818.be724115.er.aliyun-esa.net/recognize ❌
```

### 2. 确认边缘函数代码已更新

- [ ] 已复制最新版本的 `修复后的单文件代码.js`
- [ ] 已在边缘函数控制台替换代码
- [ ] 已保存并重新部署边缘函数

### 3. 检查边缘函数超时设置 ⚠️ 重要

在边缘函数控制台：

1. 进入函数设置
2. 找到 **超时时间** 或 **Timeout** 设置
3. **必须设置为 30秒或更长**（API调用需要时间）
4. 保存设置

### 4. 检查边缘函数日志

在边缘函数控制台：

1. 进入函数详情
2. 查看 **日志** 或 **Logs**
3. 查看是否有错误信息
4. 确认函数是否收到请求

### 5. 测试边缘函数直接访问

在浏览器中直接访问（测试用）：

```
POST https://orange-butterfly-4818.be724115.er.aliyun-esa.net/recognize
```

可以使用浏览器插件（如Postman）或curl命令测试。

### 6. 检查请求体大小

在浏览器开发者工具中：

1. 打开 Network 标签
2. 点击失败的 `recognize` 请求
3. 查看 **Payload** 或 **请求体**
4. 检查大小：
   - 如果超过 1MB，可能需要压缩图片
   - 如果超过 5MB，肯定会超时

### 7. 临时测试方案

如果问题持续，可以先用小图片测试：

1. 上传一张很小的图片（< 100KB）
2. 测试是否能成功
3. 如果能成功，说明是大图片导致的问题

## 可能的原因和解决方案

### 原因1：边缘函数超时设置太短

**解决方案**：
- 在边缘函数设置中增加超时时间到 30-60 秒

### 原因2：图片太大

**解决方案**：
- 在前端添加图片压缩功能
- 或者限制上传图片大小

### 原因3：网络连接不稳定

**解决方案**：
- 检查网络连接
- 尝试刷新页面重试

### 原因4：边缘函数代码未更新

**解决方案**：
- 确认已使用最新版本的代码
- 重新部署边缘函数

## 快速验证

在浏览器控制台（F12 → Console）运行：

```javascript
// 测试边缘函数是否可访问
fetch('https://orange-butterfly-4818.be724115.er.aliyun-esa.net/', {
  method: 'GET'
})
  .then(r => r.json())
  .then(console.log)
  .catch(console.error);
```

应该返回API信息。如果这个也失败，说明边缘函数本身有问题。

## 下一步操作

1. **立即检查**：边缘函数超时设置（最重要）
2. **更新代码**：使用最新版本的边缘函数代码
3. **重新部署**：前端和边缘函数都重新部署
4. **测试**：先用小图片测试

