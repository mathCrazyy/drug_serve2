# è¾¹ç¼˜å‡½æ•°æ—¥å¿—åˆ†ææŠ¥å‘Š

## ğŸ“Š æ—¥å¿—åˆ†æ

### ç¬¬ä¸€æ¡æ—¥å¿—ï¼šPOST /recognize

```json
{
  "ClientRequestMethod": "POST",
  "ClientRequestPath": "/recognize",
  "ResponseStatus": "200",
  "Duration": 9745,
  "KvStatus": "{\"totalNum\":0,\"results\":[]}",
  "FetchStatus": "{\"totalNum\":2,\"results\":[...]}"
}
```

**åˆ†æï¼š**
- âœ… è¯·æ±‚æˆåŠŸï¼ˆ200çŠ¶æ€ç ï¼‰
- âœ… æˆåŠŸè°ƒç”¨äº†2æ¬¡å¤–éƒ¨APIï¼ˆapi.chatfire.siteï¼‰
- âŒ **é—®é¢˜**ï¼š`KvStatus` æ˜¾ç¤º `totalNum: 0`ï¼Œè¯´æ˜**æ²¡æœ‰ä½¿ç”¨EdgeKVå­˜å‚¨**

### ç¬¬äºŒæ¡æ—¥å¿—ï¼šOPTIONS /history

```json
{
  "ClientRequestMethod": "OPTIONS",
  "ClientRequestPath": "/history?page=1&limit=20",
  "ResponseStatus": "200",
  "Duration": 60,
  "KvStatus": "{\"totalNum\":0,\"results\":[]}"
}
```

**åˆ†æï¼š**
- âœ… OPTIONSè¯·æ±‚æˆåŠŸï¼ˆCORSé¢„æ£€è¯·æ±‚ï¼‰
- âŒ **é—®é¢˜**ï¼š`KvStatus` æ˜¾ç¤º `totalNum: 0`ï¼Œè¯´æ˜**æ²¡æœ‰ä½¿ç”¨EdgeKVå­˜å‚¨**

## ğŸ” é—®é¢˜è¯Šæ–­

### æ ¸å¿ƒé—®é¢˜ï¼šæœªä½¿ç”¨EdgeKVå­˜å‚¨

**è¯æ®ï¼š**
- æ‰€æœ‰æ—¥å¿—ä¸­çš„ `KvStatus` éƒ½æ˜¯ `{"totalNum":0,"results":[]}`
- è¿™è¯´æ˜ä»£ç æ²¡æœ‰è°ƒç”¨EdgeKV APIï¼Œå¯èƒ½åœ¨ä½¿ç”¨å†…å­˜å­˜å‚¨

**å¯èƒ½çš„åŸå› ï¼š**

1. **ç¯å¢ƒå˜é‡æœªé…ç½®**
   - `EDGE_KV_NAMESPACE` ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–è®¾ç½®é”™è¯¯
   - ä»£ç æ£€æµ‹ä¸åˆ°EdgeKVç±»ï¼Œé™çº§åˆ°å†…å­˜å­˜å‚¨

2. **EdgeKVç±»ä¸å¯ç”¨**
   - ESAè¿è¡Œæ—¶ç¯å¢ƒä¸­EdgeKVç±»ä¸å­˜åœ¨
   - éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è®¿é—®EdgeKV

3. **ConsoleLogæ˜¯base64ç¼–ç **
   - éœ€è¦è§£ç æ‰èƒ½çœ‹åˆ°å…·ä½“çš„é”™è¯¯ä¿¡æ¯

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

1. ç™»å½• [ESAæ§åˆ¶å°](https://esa.console.aliyun.com/)
2. è¿›å…¥è¾¹ç¼˜å‡½æ•° `drug-api` çš„è¯¦æƒ…é¡µ
3. æ£€æŸ¥ **ç¯å¢ƒå˜é‡** é…ç½®ï¼š
   - ç¡®è®¤æ˜¯å¦æœ‰ `EDGE_KV_NAMESPACE` å˜é‡
   - ç¡®è®¤å˜é‡å€¼æ˜¯å¦ä¸º `drug-storage`ï¼ˆä¸KVå­˜å‚¨ç©ºé—´åç§°ä¸€è‡´ï¼‰

### æ­¥éª¤2ï¼šè§£ç ConsoleLogæŸ¥çœ‹è¯¦ç»†æ—¥å¿—

ConsoleLogæ˜¯base64ç¼–ç çš„ï¼Œéœ€è¦è§£ç æ‰èƒ½çœ‹åˆ°å…·ä½“æ—¥å¿—ã€‚å¯ä»¥åœ¨ä»£ç ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•ç«¯ç‚¹æ¥æŸ¥çœ‹æ—¥å¿—ï¼š

```javascript
// åœ¨è¾¹ç¼˜å‡½æ•°ä¸­æ·»åŠ æµ‹è¯•ç«¯ç‚¹
if (pathname === '/debug-storage') {
  const storage = getEdgeStorage();
  const namespace = getEnv('EDGE_KV_NAMESPACE', 'æœªé…ç½®');
  const hasEdgeKV = typeof EdgeKV !== 'undefined' || 
                    (typeof globalThis !== 'undefined' && globalThis.EdgeKV) ||
                    (typeof self !== 'undefined' && self.EdgeKV);
  
  return new Response(JSON.stringify({
    namespace: namespace,
    hasEdgeKV: hasEdgeKV,
    storageType: storage.constructor?.name || 'unknown',
    edgeKVAvailable: {
      global: typeof EdgeKV !== 'undefined',
      globalThis: typeof globalThis !== 'undefined' && !!globalThis.EdgeKV,
      self: typeof self !== 'undefined' && !!self.EdgeKV
    }
  }), {
    headers: { 'Content-Type': 'application/json; charset=utf-8' }
  });
}
```

è®¿é—®ï¼š`https://drug-api.be724115.er.aliyun-esa.net/debug-storage`

### æ­¥éª¤3ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæœªé…ç½®ï¼‰

å¦‚æœç¯å¢ƒå˜é‡æœªé…ç½®ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. åœ¨è¾¹ç¼˜å‡½æ•°è¯¦æƒ…é¡µï¼Œæ‰¾åˆ° **ç¯å¢ƒå˜é‡** é…ç½®
2. ç‚¹å‡» **æ·»åŠ ç¯å¢ƒå˜é‡**
3. æ·»åŠ ï¼š
   - **å˜é‡å**ï¼š`EDGE_KV_NAMESPACE`
   - **å˜é‡å€¼**ï¼š`drug-storage`
4. **é‡è¦**ï¼šä¿å­˜åå¿…é¡»é‡æ–°éƒ¨ç½²å‡½æ•°

### æ­¥éª¤4ï¼šéªŒè¯é…ç½®

éƒ¨ç½²åï¼Œå†æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
- `KvStatus` ä¸­çš„ `totalNum` å¤§äº 0ï¼ˆå¦‚æœæœ‰KVæ“ä½œï¼‰
- æˆ–è€…æŸ¥çœ‹ `ConsoleLog`ï¼ˆè§£ç åï¼‰ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
  - `[getEdgeStorage] ä½¿ç”¨EdgeKV API, namespace: drug-storage`ï¼ˆæˆåŠŸï¼‰
  - æˆ– `âš ï¸ ä¸¥é‡è­¦å‘Šï¼šä½¿ç”¨å†…å­˜å­˜å‚¨`ï¼ˆå¤±è´¥ï¼‰

## ğŸ“ æ£€æŸ¥æ¸…å•

- [ ] å·²æ£€æŸ¥è¾¹ç¼˜å‡½æ•°ç¯å¢ƒå˜é‡é…ç½®
- [ ] å·²ç¡®è®¤ `EDGE_KV_NAMESPACE=drug-storage` å·²é…ç½®
- [ ] å·²é‡æ–°éƒ¨ç½²è¾¹ç¼˜å‡½æ•°
- [ ] å·²æŸ¥çœ‹æ–°çš„æ—¥å¿—ï¼Œç¡®è®¤ `KvStatus` æœ‰æ•°æ®
- [ ] å·²è§£ç  `ConsoleLog` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

## ğŸ› å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœé…ç½®äº†ç¯å¢ƒå˜é‡ä½† `KvStatus` ä»ç„¶æ˜¯ 0ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. **EdgeKVç±»åœ¨ESAä¸­çš„è®¿é—®æ–¹å¼ä¸åŒ**
   - å¯èƒ½éœ€è¦é€šè¿‡ç‰¹å®šçš„æ–¹å¼å¯¼å…¥æˆ–è®¿é—®
   - å»ºè®®æŸ¥çœ‹ESAå®˜æ–¹æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ

2. **ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ**
   - ç¡®è®¤å·²é‡æ–°éƒ¨ç½²å‡½æ•°
   - ç¡®è®¤å˜é‡åå®Œå…¨åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

3. **EdgeKV APIè°ƒç”¨æ–¹å¼ä¸åŒ**
   - å¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„APIè°ƒç”¨æ–¹å¼
   - å»ºè®®æŸ¥çœ‹ESA EdgeKV APIæ–‡æ¡£

## ğŸ’¡ å»ºè®®

1. **ç«‹å³æ£€æŸ¥ç¯å¢ƒå˜é‡**ï¼šç¡®è®¤ `EDGE_KV_NAMESPACE` æ˜¯å¦å·²é…ç½®
2. **æŸ¥çœ‹ConsoleLog**ï¼šè§£ç base64æ—¥å¿—ï¼ŒæŸ¥çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯
3. **æ·»åŠ è°ƒè¯•ç«¯ç‚¹**ï¼šä½¿ç”¨ä¸Šé¢çš„ `/debug-storage` ç«¯ç‚¹æŸ¥çœ‹å­˜å‚¨çŠ¶æ€
4. **è”ç³»æŠ€æœ¯æ”¯æŒ**ï¼šå¦‚æœEdgeKVç±»ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦è”ç³»é˜¿é‡Œäº‘æŠ€æœ¯æ”¯æŒç¡®è®¤ESA EdgeKVçš„æ­£ç¡®ä½¿ç”¨æ–¹å¼

