# 边缘函数部署详细步骤

## 准备工作

1. 确保已登录阿里云账号
2. 已开通阿里云ESA服务
3. 准备好 `edge-function` 目录下的所有文件

## 详细部署步骤

### 步骤1：登录控制台

1. 访问 [阿里云ESA控制台](https://esa.console.aliyun.com/)
2. 使用您的阿里云账号登录
3. 选择对应的地域（Region）

### 步骤2：进入边缘函数管理

1. 在左侧导航栏找到 **边缘函数** 或 **Edge Functions**
2. 点击进入边缘函数管理页面

### 步骤3：创建新函数

1. 点击 **创建函数** 或 **新建函数** 按钮
2. 填写函数基本信息：
   - **函数名称**：`drug-recognize`（或您喜欢的名称）
   - **运行时**：选择 `Node.js 18` 或 `Node.js 18+`
   - **入口文件**：`index.js`
   - **描述**（可选）：药品识别边缘函数

### 步骤4：上传函数代码

有两种方式上传代码：

#### 方式1：在线编辑（适合小文件）

1. 在代码编辑器中，逐个创建文件
2. 复制 `edge-function` 目录下的文件内容
3. 注意文件路径和目录结构

#### 方式2：上传ZIP包（推荐）

1. 在本地打包 `edge-function` 目录：
   ```bash
   cd /Users/chunshengwu/code/drug_serve2
   cd edge-function
   zip -r drug-recognize.zip .
   ```
   或者使用图形界面：
   - 选中 `edge-function` 文件夹
   - 右键 → 压缩为 ZIP 文件

2. 在控制台上传ZIP包：
   - 找到 **上传代码** 或 **Upload Code** 选项
   - 选择刚创建的ZIP文件
   - 上传并解压

**需要上传的文件列表**：
```
edge-function/
├── index.js              # 主入口文件（必须）
├── config.js             # 配置文件（必须）
├── package.json          # 依赖配置（必须）
├── handlers/            # 处理函数目录
│   ├── recognize.js
│   ├── history.js
│   └── merge.js
└── utils/               # 工具函数目录
    ├── doubaoApi.js
    ├── parser.js
    └── storage.js
```

### 步骤5：配置环境变量

1. 在函数配置页面找到 **环境变量** 或 **Environment Variables**
2. 点击 **添加环境变量** 或 **Add Environment Variable**
3. 逐个添加以下环境变量：

| 变量名 | 变量值 | 说明 |
|--------|--------|------|
| `DOUBAO_API_BASE_URL` | `https://api.chatfire.site/v1/chat/completions` | 豆包API地址 |
| `DOUBAO_API_KEY` | `sk-pzZXi9zXV9ERBJFrjAVV4WEMj6u7TcTLtoNUkRfefSrLxlid` | 豆包API密钥 |
| `DOUBAO_MODEL` | `doubao-seed-1-6-vision-250815` | 使用的模型 |
| `DOUBAO_MAX_TOKENS` | `1000` | 最大token数 |
| `DOUBAO_TEMPERATURE` | `0.1` | 温度参数 |
| `STORAGE_PREFIX` | `drug_record:` | 存储前缀 |
| `STORAGE_INDEX_PREFIX` | `drug_index:` | 索引前缀 |

**注意**：
- 变量名必须完全匹配（区分大小写）
- 变量值不要有多余的空格
- 保存所有环境变量

### 步骤6：配置函数设置

1. **超时时间**：建议设置为 `30秒` 或更长（API调用可能需要时间）
2. **内存**：建议 `256MB` 或更高
3. **并发数**：根据需求设置

### 步骤7：部署函数

1. 检查所有配置是否正确
2. 点击 **部署** 或 **Deploy** 按钮
3. 等待部署完成（通常需要几十秒）
4. 查看部署日志，确认没有错误

### 步骤8：获取函数URL

1. 部署成功后，在函数详情页面找到 **访问地址** 或 **Function URL**
2. 复制函数URL，格式类似：
   ```
   https://xxx-xxx.esa.aliyuncs.com
   ```
3. 保存这个URL，后续需要配置到前端

### 步骤9：测试函数

1. 在控制台找到 **测试** 或 **Test** 功能
2. 创建一个测试请求：
   ```json
   {
     "method": "POST",
     "path": "/recognize",
     "body": {
       "images": [
         {
           "base64": "test",
           "name": "test.jpg",
           "type": "image/jpeg"
         }
       ]
     }
   }
   ```
3. 执行测试，查看返回结果
4. 检查日志，确认函数正常运行

### 步骤10：配置CORS（如需要）

1. 在函数配置中找到 **CORS设置**
2. 确保允许前端域名的跨域请求
3. 当前代码已配置 `Access-Control-Allow-Origin: *`，允许所有来源

## 常见问题

### Q1: 上传代码后提示找不到模块

**解决方案**：
- 确保 `package.json` 已上传
- 检查文件路径是否正确
- 确认所有依赖文件都在正确位置

### Q2: 函数执行超时

**解决方案**：
- 增加函数超时时间设置
- 检查API调用是否正常
- 查看函数日志定位问题

### Q3: 环境变量未生效

**解决方案**：
- 确认变量名拼写正确（区分大小写）
- 重新部署函数
- 检查代码中是否正确读取环境变量

### Q4: 如何查看函数日志

1. 在函数详情页面找到 **日志** 或 **Logs**
2. 查看实时日志或历史日志
3. 根据日志信息排查问题

## 部署后操作

1. **获取函数URL**：复制函数访问地址
2. **配置前端**：在ESA Pages中设置环境变量 `VITE_API_BASE_URL`
3. **测试功能**：访问前端应用，测试识别功能

## 验证清单

- [ ] 函数已创建
- [ ] 所有文件已上传
- [ ] 环境变量已配置
- [ ] 函数已成功部署
- [ ] 已获取函数URL
- [ ] 函数测试通过
- [ ] 前端已配置函数URL
- [ ] 整体功能测试通过

## 下一步

部署完成后，请：
1. 将函数URL配置到前端环境变量
2. 重新部署前端应用
3. 测试完整的识别流程

