# ERR_CONNECTION_CLOSED 错误排查

## 问题现象

前端调用边缘函数时出现 `ERR_CONNECTION_CLOSED` 错误，连接被关闭。

## 可能原因

1. **请求体太大**：图片base64编码后数据量很大，可能导致超时
2. **边缘函数超时**：函数执行时间超过限制
3. **请求体读取问题**：读取方式不正确
4. **网络问题**：连接不稳定

## 解决方案

### 1. 检查边缘函数超时设置

在边缘函数控制台：
- 检查函数超时时间设置
- 建议设置为 **30秒** 或更长
- API调用可能需要较长时间

### 2. 优化图片大小

在前端添加图片压缩（可选）：

```typescript
// 在 frontend/src/utils/imageUtils.ts 中添加压缩功能
export function compressImage(file: File, maxWidth = 1920, quality = 0.8): Promise<string> {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx?.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = (reader.result as string).split(',')[1];
            resolve(base64);
          };
          reader.readAsDataURL(blob!);
        }, 'image/jpeg', quality);
      };
      img.src = e.target?.result as string;
    };
    reader.readAsDataURL(file);
  });
}
```

### 3. 检查网络请求

在浏览器开发者工具中：
1. 打开 Network 标签
2. 查看 `/recognize` 请求
3. 检查：
   - 请求URL是否正确
   - 请求方法是否为 POST
   - 请求体大小（如果太大可能需要压缩）
   - 响应状态码

### 4. 测试边缘函数

直接在浏览器或使用curl测试：

```bash
curl -X POST https://drug-api.be724115.er.aliyun-esa.net/recognize \
  -H "Content-Type: application/json" \
  -d '{"images":[{"base64":"test","name":"test.jpg","type":"image/jpeg"}]}'
```

### 5. 查看边缘函数日志

在边缘函数控制台查看日志，确认：
- 函数是否正常执行
- 是否有错误信息
- 执行时间是否过长

## 已修复的问题

代码已更新，修复了：
- ✅ 请求体读取逻辑
- ✅ 错误处理
- ✅ 超时处理

## 下一步

1. 更新边缘函数代码（使用最新版本）
2. 检查函数超时设置（建议30秒以上）
3. 测试小图片（先测试单张小图片）
4. 如果仍有问题，查看边缘函数日志

